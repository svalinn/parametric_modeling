# Introduction to MTOT

Made-to-Order Tokamak (MTOT) is a tool for the generation of CAD models of tokamak fusion reactor geometries. Specifically, it uses Coreform Cubit/Trelis to generate a SAT file of a tokamak geometry with the option for a DAGMC H5M file, for Monte Carlo (MC) simulation, if the Cubit/Trelis Svalinn plugin is installed (instructions [here](https://svalinn.github.io/DAGMC/install/plugin.html)). The script only requires that tokamak major and minor radii and a 1D radial build be defined.

To demonstrate MTOTâ€™s use and integration with MC simulation, the following tutorial has been created. Specifically, this tutorial will walk the user through a tritium breeding ratio (TBR) calculation in the open-source MC code OpenMC using a simple circular tokamak geometry generated via MTOT. DAGMC must be installed for use with OpenMC (instructions [here](https://svalinn.github.io/DAGMC/install/openmc.html)) and OpenMC must be configured specifically to allow DAGMC geometries (instructions [here](https://docs.openmc.org/en/stable/usersguide/install.html#prerequisites))

###### Overview

1. Write radial build file
2. Execute MTOT on radial build file
3. Write OpenMC script
4. Run OpenMC

## The Radial Build File

MTOT uses the YAML file format for its radial build files in an effort to emphasize human readability and ease of use. Each line in the file represents a discrete, homogenized layer in the tokamak. Each layer must be given a name and a thickness in cm (the layer name will be used later in OpenMC for the material definition, so it is best to use something descriptive). For the purpose of the TBR calculation, we will only include the following regions of the tokamak: first wall, breeder, back wall. Below is the syntax for the YAML file (the file itself can be downloaded [here](https://github.com/connoramoreno/parametric_modeling/ExampleRadialBuilds/radialbuild_introduction.yaml)):

    - first_wall: 4
    - breeder: 49
    - back_wall: 2

## Using MTOT

Now that the radial build file is ready, MTOT can be executed. MTOT is a command-line-executable python script and the syntax to do so follows the form

    python [path to MTOT.py] [path to radial build file] [major radius] [minor radius] [options]

Use the help optional argument (-h, --help) for more information. For this tutorial, a major radius of 480 cm and a minor radius of 130 cm are used, and the optional arguments `-d` and `-g` are used to include a DAGMC export and a graveyard volume, respectively:

    python path/to/script/MTOT.py path/to/radial/build 480 130 -d -g

Cubit/Trelis will create the SAT file rather quickly but please allow the program a few minutes to create the DAGMC geometry. In the meantime, the user can examine the SAT file in Cubit/Trelis both to observe the product of the script and to confirm whether the geometry was created as desired. Below is a cross section of the geometry using the previously mentioned parameters.

| ![Cross section of the circular tokamak geometry](https://github.com/connoramoreno/parametric_modeling/Tutorials/Introduction/Tokamak_CrossSection.png "Circular tokamak cross section") |
|:--:|
| Cross section of the circular tokamak geometry generated by MTOT. At the toroidal center is the plasma/vaccum region. Radially outward, in series, are the first wall, breeder, and back wall regions. |

## OpenMC

Using OpenMC's python API, the user can now write a python script that will run a TBR calculation on the tokamak model just created (the script itself can be downloaded [here](https://github.com/connoramoreno/parametric_modeling/Tutorials/Introduction/Introduction.py)). To do so, the user will need to specify material compositions for each tokamak layer, run settings, a source, and the necessary tally. First, define the materials needed for the first wall region:

    import openmc
    from math import pi
    
    # Define materials
    # Tungsten armor, assuming 8.7% void
    Armor = openmc.Material()
    Armor.add_element('W', 1.0)
    Armor.set_density('g/cm3', 19.35*0.913)
    
    # Reduced Activation Ferritic Martensitic steel (based on the EUROFER97 alloy)
    RAFM = openmc.Material()
    RAFM.add_element('Fe', 0.9, 'wo')
    RAFM.add_element('Cr', 0.09, 'wo')
    RAFM.add_element('W', 0.01, 'wo')
    RAFM.set_density('g/cm3', 7.8)
    
    # Pressurized helium coolant (8 MPa, 673 K)
    He = openmc.Material()
    He.add_element('He', 1.0)
    He.set_density('g/cm3', 5.723e-3)

Now, mix these materials homogeneously throughout the volume and give the definition the same name as the layer name in the radial build:

    # Define first wall material
    First_Wall = openmc.Material.mix_materials([Armor, RAFM, He], [0.05, 0.323, 0.627], 'vo', 'first_wall')

Second, define additional materials needed for the breeder region:

    # Lead-lithium eutectic breeder/multiplier
    PbLi = openmc.Material()
    PbLi.add_element('Pb', 0.84, 'ao')
    PbLi.add_element('Li', 0.16, 'ao', 90.0, enrichment_target='Li6', enrichment_type='ao')
    PbLi.set_density('g/cm3', 10.5)
    
    # Silicon carbide flow channel insert
    SiC = openmc.Material()
    SiC.add_element('Si', 0.5, 'ao')
    SiC.add_element('C', 0.5, 'ao')
    SiC.set_density('g/cm3', 3.21)

Mix these materials homogeneously throughout the volume and give the appropriate name:

    # Define breeder material
    Breeder = openmc.Material.mix_materials([RAFM, He, PbLi, SiC], [0.075, 0.149, 0.737, 0.039], 'vo', 'breeder')

Lastly, give the back wall its homogeneous material definition:

    # Define back wall material
    Back_Wall = openmc.Material.mix_materials([RAFM, He], [0.8, 0.2], 'vo', 'back_wall')

Now, compile the materials:

    # Compile materials
    mat = openmc.Materials([First_Wall, Breeder, Back_Wall])
    mat.export_to_xml()

Define the simulation's run settings. Note that the DAGMC geometry option is set to true (this allows MTOT's model to be used):

    # Define run settings
    settings = openmc.Settings()
    settings.dagmc = True
    settings.run_mode = 'fixed source'
    settings.particles = 10000
    settings.batches = 10

Next, define the simulation's source. For this tutorial, an isotropic, 14.1 MeV ring source at the tokamak major radius is used.

    # Define source
    source = openmc.Source()
    r = openmc.stats.Discrete([480.0], [1.0])
    phi = openmc.stats.Uniform(0.0, 2*pi)
    z = openmc.stats.Discrete([0.0], [1.0])
    source.space = openmc.stats.CylindricalIndependent(r, phi, z)
    source.angle = openmc.stats.Isotropic()
    source.energy = openmc.stats.Discrete([14.1e6], [1.0])

Compile the simulation settings:

    # Compile settings
    settings.source = source
    settings.export_to_xml()

Finally, define the TBR tally and compile:

    # Define tallies
    # Tally TBR in breeder
    TBR = openmc.Tally(name='TBR')
    TBR.scores = ['H3-production']
    
    # Compile tallies
    tallies = openmc.Tallies([TBR])
    tallies.export_to_xml()

At the end of the script, tell OpenMC to run the simulation:

    # Run simulation
    openmc.run()

Now that the OpenMC script has been created, the user can execute the script via the command line:

    python path/to/OpenMC/script

If the user defined all parameters, materials, and settings the same as this tutorial, the result of the TBR calculation should be something similar to

    =========================>     TALLY 1: TBR     <==========================
    
     Cell 6
       Total Material
         (n,Xt)                               1.11642 +/- 0.00298077
